<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>美女图片</title>
    <link rel="stylesheet" href="css/ccKit.css"/>
    <link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/index.css"/>
</head>
<body>

<div class="header cc-x24">
    <div class="cc-container">
        <div class="logo">
            Picture
        </div>
        <ul class="menu">
            <li><a href="">全部图片</a></li>
            <li><a href="">美女</a></li>
            <li><a href="">风景</a></li>
            <li><a href="">明星</a></li>
            <li><a href="">壁纸</a></li>
            <li><a href="">清新</a></li>
            <li><a href="">动漫</a></li>
        </ul>
    </div>
</div>

<div class="main cc-x24 cc-clearfix">

    <div class="container">
        &nbsp;
        <ul class="image-layer">

        </ul>

        <ul class="cc-pagination cc-right">

        </ul>
    </div>

</div>

<script src="js/jquery.min.js"></script>
<script>

    'use strict';

    Array.prototype.max = function() {
        var max = this[0];
        var len = this.length;
        for (var i = 1; i < len; i++){
            if (this[i] > max) {
                max = this[i];
            }
        }
        return max;
    };

    //把url的?后面的参数转换成对象
    String.prototype.urlDecode = function(){

        var _this, dic;
        if(this.substr(0,1)=='?'){
            _this = this.substr(1);
        }else{
            _this = this;
        }
        _this = decodeURI(_this);
        dic = {};
        _this.split('&').forEach(function(element){
            var array = element.split('=');
            dic[array[0]] = array[1];
        });
        return dic;
    };

    //把对象转换成get字符串形式，开头会带?
    String.prototype.urlEncode = function () {

        var s, json;

        s = '?';
        json = JSON.parse(this);

        for(var i in json){
            if(i == 'urlEncode'){
                continue;
            }
            s += i+'='+json[i]+'&';
        }
        if(s.substr(s.length-1)=='&'){
            s = s.substr(0, s.length-1);
        }

        s = encodeURI(s);
        return s;
    };

    //get查询字段的添加，有会更新，无则增加
    String.prototype.queryUpdate = function (json) {
        var dic = this.urlDecode();
        for(var i in json){
            dic[i] = json[i];
        }
        return JSON.stringify(dic).urlEncode();
    };
    //检测get字符串是否含有字段
    String.prototype.checkField = function(field){
        var dic = this.urlDecode();
        return dic[field] ? true : false;
    };

    (function($){

        //图片延迟加载。 只加载实际需要的大小
        $.fn.lazyLoad = function(){
            var _this = $(this);
            var imgUrl, imgWidth, imgHeight, realWidth;

            realWidth = _this.find('>li').width();

            //计算真实大小和地址
            var change = function(_src, _width, _height, realWidth){
                var percent, width, height, src;
                _width = parseInt(_width);
                _height = parseInt(_height);

                percent = realWidth/_width;
                width = realWidth;
                height = parseInt(_height*percent);
                src = 'getImage/?path='+_src+'&width='+width+'&height='+height;
                return {
                    src: src,
                    width: width,
                    height: height
                }
            };

            //开始加载图片
            _this.find('img').each(function(index, element){
                var image = $(element);
                imgUrl = image.attr('data-src');
                imgWidth = image.attr('data-width');
                imgHeight = image.attr('data-height');

                var attr = change(imgUrl, imgWidth, imgHeight, realWidth);
                image.attr(
                        {
                            'src': attr.src,
                            'width': attr.width,
                            'height': attr.height
                        }
                );

            });

            return this;
        };

        //瀑布流
        $.fn.Masonry = function () {
            var _this = $(this);
            var _width, height;

            _width = _this.find('>li').outerWidth();

            var  heights = [0, 0, 0, 0, 0];

            _this.find('>li').each(function (index, element) {
                var li = $(element);
                var num = index%5;
                if(num !== 0){
                    if(heights[num] > heights[num-1]){
                        num--;
                    }
                }else if(num === 0){
                    if(heights[num] > heights[4]){
                        num = 4;
                    }
                }
                li.css({'left': _width*num, 'top': heights[num]});
                heights[num] += li.outerHeight();
            });
            _this.css('height',heights.max());
        }

    })(jQuery);

    (function($){

        var _this      = $('.main'),
            imageLayer = _this.find('.image-layer'),
            pagination = $('.cc-pagination'),
            url        = '/imgList',
            getPageUrl = '/imgListPageLength';

        function parseUrl(url){

            var dic={};
            dic.page = 1;// 设置初始值，不然属性会变成只读
            url.replace('?','').split('&').forEach(function(element){
                dic[element.split('=')[0]] = element.split('=')[1];
            });
            return dic;
        }
        //输出分页
        function getPagination(pageActive, pageCount){

            var domain, pathName, query, _page;

            pageActive = parseInt(pageActive);
            pageCount = parseInt(pageCount);

            pathName = location.pathname;
            domain = location.origin;
            query = location.search;

            //插入数字页码
            for(var i = 0; i<pageCount; i++){
                if(i==pageActive-1){
                    pagination.append('<li class="active">'+(i+1)+'</li>');
                }else{
                    _page = i+1;
                    query = query.queryUpdate({page: _page});
                    pagination.append('<li><a href="'+pathName+query+'">'+(i+1)+'</a></li>');
                }
            }
            //插入上下翻页，和首尾翻页
            if(pageActive!=1){
                _page = i+1;
                pagination.prepend('<li><a href="index.html?page='+(pageActive-1)+'">&lt;</a></li>');
            }
            if(pageActive>2){
                pagination.prepend('<li><a href="index.html?page=1">&lt;&lt;</a></li>');
            }
            if(pageActive!=pageCount){
                pagination.append('<li><a href="index.html?page='+(pageActive+1)+'">&gt;</a></li>');
            }
            if(pageActive<pageCount-1){
                pagination.append('<li><a href="index.html?page='+(pageCount+1)+'">&gt;&gt;</a></li>');
            }
        }

        // 判断是否有参数
        var params = location.search.urlDecode();
        if(location.search.checkField('c')){
            url += location.search.queryUpdate({c: params.c, page: params.page});
            getPageUrl += location.search.queryUpdate({c: params.c});
            //url += 'c='+params.c+'&page='+params.page;
        }else{
            //url += 'page='+params.page;
            url += location.search.queryUpdate({page: params.page});
        }

        //获取页码
        $.ajax(getPageUrl).success(function(response){
            params.page = params.page || 1;
            getPagination(params.page, response);
        }).error(function(e){
            console.log(e.statusText);
        });

        //获取图片并渲染
        $.ajax(url).success(function(response){
            response.forEach(function(element){
                imageLayer.append('<li><img data-src="'+element.url+'" alt=" " data-width="'+element.width+'" data-height="'+element.height+'"/></li>');
            });
            $('.image-layer').lazyLoad().Masonry();
        }).error(function(e){
            console.log(e);
        });

    })(jQuery);

</script>
</body>
</html>