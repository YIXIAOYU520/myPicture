<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>美女图片</title>
    <link rel="stylesheet" href="css/ccKit.css"/>
    <link rel="stylesheet/less" href="css/index.less"/>
    <style>

    </style>
</head>
<body>

<div class="header cc-x24">
    <div class="logo">
        Picture
    </div>
    <ul class="menu">
        <li><a href="">全部图片</a></li>
        <li><a href="">美女</a></li>
        <li><a href="">风景</a></li>
        <li><a href="">明星</a></li>
        <li><a href="">壁纸</a></li>
        <li><a href="">清新</a></li>
        <li><a href="">动漫</a></li>
    </ul>
</div>

<div class="main cc-x24 cc-clearfix">

    <div class="container">
        &nbsp;
        <ul class="image-layer">

        </ul>

    </div>

</div>

<script src="plugins/less.min.js"></script>
<script src="js/jquery.min.js"></script>
<script>

    'use strict';
    (function($){

        $.fn.lazyLoad = function(){
            var _this = $(this);
            var imgUrl, imgWidth, imgHeight, realWidth;

            realWidth = _this.find('>li').width();

            //计算真实大小和地址
            var change = function(_src, _width, _height, realWidth){
                var percent, width, height, src;
                _width = parseInt(_width);
                _height = parseInt(_height);

                percent = realWidth/_width;
                console.log(percent);
                width = realWidth;
                height = parseInt(_height*percent);
                src = 'getImage/?path='+_src+'&width='+width+'&height='+height;
                return {
                    src: src,
                    width: width,
                    height: height
                }
            };

            //开始加载图片
            _this.find('img').each(function(index, element){
                var image = $(element);
                imgUrl = image.attr('data-src');
                imgWidth = image.attr('data-width');
                imgHeight = image.attr('data-height');

                var attr = change(imgUrl, imgWidth, imgHeight, realWidth);
                image.attr(
                        {
                            'src': attr.src,
                            'width': attr.width,
                            'height': attr.height
                        }
                );

            });

            return this;
        };

        $.fn.Masonry = function () {
            var _this = $(this);
            var _left, _top, _width, height;

            _width = _this.find('>li').outerWidth();

            var  heights = [0, 0, 0, 0, 0];

            _this.find('>li').each(function (index, element) {
                var li = $(element);
                var num = index%5;
                if(num !== 0){
                    if(heights[num] > heights[num-1]){
                        num--;
                    }
                }else if(num === 0){
                    if(heights[num] > heights[4]){
                        num = 4;
                    }
                }
                li.css({'left': _width*num, 'top': heights[num]});
                heights[num] += li.outerHeight();
            });
        }

    })(jQuery);

    (function($){

        var _this      = $('.main'),
            imageLayer = _this.find('.image-layer'),
            url        = '/imgList?';

        function parseUrl(url){

            var dic={};

            if(!url){
                return false;
            }
            url.replace('?','').split('&').forEach(function(element, index){
                dic[element.split('=')[0]] = element.split('=')[1];
            });
            return dic;
        }

        // 判断是否有参数
        var params = parseUrl(location.search);
        if(params.c){
            url = url+'c='+params.c;
        }

        $.ajax(url).success(function(response){

            response.forEach(function(element,index){
                imageLayer.append('<li><img data-src="'+element.url+'" alt=" " data-width="'+element.width+'" data-height="'+element.height+'"/></li>');
            });
            $('.image-layer').lazyLoad().Masonry();

        });

    })(jQuery);

</script>
</body>
</html>